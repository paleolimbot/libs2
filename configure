
# https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Using-cmake

if [ -d tools/dist ]; then
  echo "Already built"
else
  echo "building"
  mkdir tools/build && cd tools/build
  cmake ../../tools/vendor/s2geography -DS2GEOGRAPHY_S2_SOURCE=BREW -DBUILD_SHARED_LIBS=OFF
  cmake --build .
  cmake --install . --prefix=../dist
  cd ../..
fi

PKG_LIBS="-L`pwd`/tools/dist/lib -ls2geography -I/opt/homebrew/Cellar/s2geometry/0.10.0_5/lib -ls2 -L/opt/homebrew/Cellar/abseil/20230802.1 -L/opt/homebrew/Cellar/openssl@3/3.1.2/lib -lcrypto -lssl"
PKG_CFLAGS="-I`pwd`/tools/dist/include -I/opt/homebrew/Cellar/s2geometry/0.10.0_5/include -I/opt/homebrew/Cellar/abseil/20230802.1/include -I/opt/homebrew/Cellar/openssl@3/3.1.2/include"

# From apache/arrow/r/configure:
# If on Raspberry Pi, need to manually link against latomic
# See: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=81358 for similar example
if grep raspbian /etc/os-release >/dev/null 2>&1; then
  PKG_LIBS="-latomic $PKG_LIBS"
fi

echo "Using PKG_LIBS=$PKG_LIBS"
echo "Using PKG_CFLAGS=$PKG_CFLAGS"


# Write to Makevars
sed -e "s|@cflags@|$PKG_CFLAGS|" -e "s|@libs@|$PKG_LIBS|" src/Makevars.in > src/Makevars

# Success
exit 0
